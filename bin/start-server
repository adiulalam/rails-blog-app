#!/bin/bash -e

# Variables
CONTAINER_NAME="rails-postgres"
POSTGRES_VERSION="15" # Specify the desired PostgreSQL version
POSTGRES_USER="admin"
POSTGRES_DB="rails_blog_app_development"
POSTGRES_PORT="5432"

# Check if the container already exists
if [ "$(docker ps -aq -f name=${CONTAINER_NAME})" ]; then
  echo "Container with the name ${CONTAINER_NAME} already exists. Stopping and removing it."
  docker stop ${CONTAINER_NAME} > /dev/null 2>&1
  docker rm ${CONTAINER_NAME} > /dev/null 2>&1
fi

# Run PostgreSQL container with restart policy
echo "Creating a PostgreSQL container named ${CONTAINER_NAME}..."
docker run -d \
  --name ${CONTAINER_NAME} \
  --restart=unless-stopped \
  -e POSTGRES_USER=${POSTGRES_USER} \
  -e POSTGRES_DB=${POSTGRES_DB} \
  -e POSTGRES_HOST_AUTH_METHOD=trust \
  -p ${POSTGRES_PORT}:5432 \
  postgres:${POSTGRES_VERSION}

# Check if the container started successfully
if [ $? -eq 0 ]; then
  echo "PostgreSQL instance created successfully!"
  echo "Connection details:"
  echo "  Host: localhost"
  echo "  Port: ${POSTGRES_PORT}"
  echo "  Username: ${POSTGRES_USER}"
  echo "  Database: ${POSTGRES_DB}"
else
  echo "Failed to create the PostgreSQL instance."
  exit 1
fi
